// Lokasi File: prisma/schema.prisma

datasource db {
  provider = "postgresql" // atau "mysql", sesuai database Anda
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// === Model/Tabel Kita ===

model Role {
  role_id   Int    @id @default(autoincrement())
  role_name String @unique
  users     User[]
}

model Division {
  division_id   Int    @id @default(autoincrement())
  division_name String @unique
  users         User[]
}

model User {
  user_id     Int      @id @default(autoincrement())
  name        String
  email       String   @unique
  password    String
  role_id     Int?
  role        Role?    @relation(fields: [role_id], references: [role_id])
  division_id Int?
  division    Division? @relation(fields: [division_id], references: [division_id])
  jabatan     String? 
  toko        String? 
  
  // --- PERUBAHAN DI SINI ---
  // Menambahkan kolom status untuk "Soft Delete"
  status      String   @default("Active") // 'Active' atau 'Inactive'
  // -------------------------

  // Relasi
  submittedTickets Ticket[] @relation("SubmittedBy")
  logs             TicketLog[] @relation("Actor")
  assignments      TicketAssignment[] @relation("AssignedTo")

  @@index([role_id])
  @@index([division_id])
}

model Ticket {
  ticket_id          BigInt   @id @default(autoincrement())
  title              String
  submitted_by_user_id Int
  type               String   @default("Pending")
  status             String   @default("Open")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  kategori           String
  sub_kategori       String
  jabatan     String? 
  toko        String? 

  // Relasi
  submittedBy User             @relation("SubmittedBy", fields: [submitted_by_user_id], references: [user_id])
  detail      TicketDetail?
  logs        TicketLog[]
  assignments TicketAssignment[]

  @@index([submitted_by_user_id])
  @@index([type])
  @@index([status])
}

model TicketDetail {
  ticket_id        BigInt   @id
  description      String   @db.Text 
  attachments_json Json?    
  ticket           Ticket   @relation(fields: [ticket_id], references: [ticket_id], onDelete: Cascade)
}

model TicketLog {
  log_id        BigInt   @id @default(autoincrement())
  ticket_id     BigInt
  actor_user_id Int
  action_type   String
  notes         String?  @db.Text
  timestamp     DateTime @default(now())

  // Relasi
  ticket Ticket @relation(fields: [ticket_id], references: [ticket_id], onDelete: Cascade)
  actor  User   @relation("Actor", fields: [actor_user_id], references: [user_id])

  @@index([ticket_id])
  @@index([actor_user_id])
}

model TicketAssignment {
  assignment_id   BigInt   @id @default(autoincrement())
  ticket_id       BigInt
  user_id         Int
  assignment_type String   
  status          String   @default("Pending") 
  createdAt       DateTime @default(now())

  // Relasi
  ticket Ticket @relation(fields: [ticket_id], references: [ticket_id], onDelete: Cascade)
  user   User   @relation("AssignedTo", fields: [user_id], references: [user_id])

  @@index([ticket_id])
  @@index([user_id, status]) 
}